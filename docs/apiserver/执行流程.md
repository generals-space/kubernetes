## 启动流程

```
cmd/kube-apiserver/apiserver.go
main(): 程序入口
|
└─  cmd/kube-apiserver/app/server.go
    NewAPIServerCommand(): 解析命令行选项.
    |   创建`ServerRunOptions`对象, 设置默认值, 对传入的参数进行补全并验证
    |   
    ├─  cmd/kube-apiserver/app/options/options.go
    |   NewServerRunOptions(): 创建`ServerRunOptions`对象.
    |
    └─  cmd/kube-apiserver/app/server.go
        Run(): 使用传入的选项对象开始运行, 不会退出.
        |
        ├─  server = CreateServerChain(): 创建多个server(同时构造各server的配置对象)
        |   |   扩展server, 核心server, 聚合server, http server, 此函数之后还有https server.
        |   |   这里的server是聚合server `APIAggregator`对象.
        |   |
        |   ├─  CreateKubeAPIServerConfig(): 创建kubeAPIServerConfig配置
        |   |   |
        |   |   └─  buildGenericConfig(): 根据传入的 ServerRunOptions 参数, 构造 genericapiserver.Config 对象, 以及其他相关对象.
        |   |       |   
        |   |       └─  staging/src/k8s.io/apiserver/pkg/server/config.go
        |   |           NewConfig(): 使用默认值初始化 Config 对象并返回.
        |   |           |   BuildHandlerChainFunc 成员: 为 apiHandler 添加了很多默认的中间件(java中也有说叫filter过滤器), 有十几种.
        |   |           |   注意这里虽然为此成员字段赋值, 但并未执行.
        |   |
        |   |
        |   |
        |   ├─  CreateKubeAPIServer(): 创建核心server, 是一个Master{}对象, 同时会向其中挂载/,/swagger-ui等路由.
        |       | 
        |       ├─  kubeAPIServerConfig.Complete().New()
        |       |   |
        |       |   └─  pkg/master/master.go
        |               completedConfig.New() 根据已有的配置文件创建 Master{} 对象, 初始化其中的 GenericAPIServer 成员, 同时挂载内置路由.
        |               |   加载/api及/apis开头的路由(加载/api路由的方法叫作InstallLegacyAPI, 是因为这其中的资源很古老很核心, 所以叫Legacy).
        |               |
        |               ├─  staging/src/k8s.io/apiserver/pkg/server/config.go
        |               |   completedConfig.New(): 初始化apiServerHandler对象, 并赋值给 GenericAPIServer(返回对象).Handler 成员
        |               |   |   同时挂载了几条内置路由, 包括: /、/swagger-ui、/debug/*、/metrics、/version
        |               |   |   另外, 在挂载实际路由之前, 还通过调用 BuildHandlerChainFunc() 成员函数, 加载了十几种中间件, 包括RBAC, cors跨域及panic恢复等操作.
        |               |
        |               ├─  Master.InstallLegacyAPI(): 加载/api开头的路由, 提供资源访问入口
        |               |
        |               ├─  Master.InstallAPIs(): 加载/apis开头的路由, 提供资源访问入口
        |
        ├─  staging/src/k8s.io/kube-aggregator/pkg/apiserver/apiserver.go
        |   prepared = server.PrepareRun(): 这里的prepared为`preparedAPIAggregator`对象
        |   说是准备工作, 不如说是启动前的路由收尾工作. 
        |   主要完成了Swagger和OpenAPI路由的注册工作(Swagger和OpenAPI主要包含了Kubernetes API的所有细节与规范), 
        |   并完成/healthz路由的注册工作.
        |
        |
        └─  staging/src/k8s.io/kube-aggregator/pkg/apiserver/apiserver.go
            preparedAPIAggregator.Run()
            |
            └─  preparedAPIAggregator.runnable.Run(): 这里的`runnable`为
                |   `preparedAPIAggregator.APIAggregator.GenericAPIServer.PrepareRun()`的返回值.
                |
                └─  staging/src/k8s.io/apiserver/pkg/server/genericapiserver.go
                    |   preparedGenericAPIServer.Run(): 这里是核心 server 真正启动的地方. 
                    |   通过`NonBlockingRun()`启动安全的https server.
                    |   非安全方式的启动在`CreateServerChain()`中已经完成.
                    |
                    ├─  preparedGenericAPIServer.NonBlockingRun(): 
```

## RBAC流程

RBAC是在核心server启动前挂载中间件和路由handler的部分完成加载的, 在`staging/src/k8s.io/apiserver/pkg/server/config.go`中, 成员函数中`BuildHandlerChainFunc()`, 实际是被赋值了的`DefaultBuildHandlerChain()`函数.

```
staging/src/k8s.io/apiserver/pkg/server/config.go
DefaultBuildHandlerChain(): 为 apiHandler 挂载中间件
|
└─  staging/src/k8s.io/apiserver/pkg/endpoints/filters/authorization.go
    WithAuthorization():
    |
    ├─ GetAuthorizerAttributes(): 
    |
    ├─ 
```

## ETCD存储

```
pkg/master/master.go
Master.InstallLegacyAPI()
|
├─  pkg/registry/core/rest/storage_core.go
    LegacyRESTStorageProvider.NewLegacyRESTStorage():
    |
    |   podTemplateStorage, _ := podtemplatestore.NewREST()
    |   podStorage, _ := podstore.NewStorage()
    |   NewREST()与NewStorage()的区别在于, `REST`对象中包含着一个`Storage`对象...相当于对ta做了一层封装.
    |
```

## 请求流程

路由挂载过程

```
pkg/master/master.go
Master.New()
|
├─  Master.InstallLegacyAPI()
    |
    ├─  pkg/registry/core/rest/storage_core.go
    |   LegacyRESTStorageProvider.NewLegacyRESTStorage(): 创建`APIGroupInfo`对象
    |       APIGroupInfo.VersionedResourcesStorageMap["v1"]是各种资源(pod,node,event)的name与storage映射map
    |
    ├─  staging/src/k8s.io/apiserver/pkg/server/genericapiserver.go
        GenericAPIServer.InstallLegacyAPIGroup(), 与 InstallAPIs(): 分别准备装载 /api, /apis 两个前缀下的路由
        |
        ├─  GenericAPIServer.installAPIResources(): 遍历 apiGroupInfo 下的 v1, betav1 等groupVersion,
            |   将ta们其下的各种资源name与storage映射, 加载到以apiPrefix为前缀的路由下.
            |
            ├─  staging/src/k8s.io/apiserver/pkg/endpoints/groupversion.go
                APIGroupVersion.InstallREST():
                |
                ├─  staging/src/k8s.io/apiserver/pkg/endpoints/installer.go
                |   APIInstaller.Install(): 遍历成员对象 group 中的 Storage, 重构成有序列表后依次注册到指定前缀下.
                |   |   返回的 WebService 对象, 有点像其他http框架中的 RouteGroup, 是一组 Route 对象的组合.
                |   |
                |   ├─  APIInstaller.registerResourceHandlers()
                |       |   registerResourceHandlers() 遍历目标资源(pod, pod/log等)支持的所有操作(get/list等), 
                |       |   将不同的操作注册为不同的路由(Create对应Post, Update对应Put等), 并与后端 Storage 的不同方法绑定.
                |       |   其中不同资源可执行的操作也不相同, 判断逻辑是, 各资源的Storage对象是否实现了 Getter, Lister 的接口,
                |       |   如果是, 则可以进行 get, list 操作.
                |       |   路由的 handler 部分在 staging/src/k8s.io/apiserver/pkg/endpoints/handlers/目录下, 
                |       |   有各种方法对应的源文件.
                |       |   但最终其实还是各种资源的 Storage 做了类型断言, 即ta们的 Storage 对象实现了 Get(), List() 方法.
                |       |   以 legacy 资源为例, ta们的 storage 构造函数都在 pkg/registry/core/{pod,node...}/storage/ 目录下,
                |       |   ta们的子资源也是.
                |
                |
                ├─  container.Add(ws): 把`APIInstaller.Install()`生成的 WebService, 添加到Container中.
                |   |   go-restful 中的 Container 就类似其他web框架中的Server对象一样.
                |
```

在`pkg/registry/core/{pod,node...}/storage/`目录下, 你可能会发现很多资源的`Storage`对象连`Get`, `List`等方法都没有实现, 可能是因为ta们继承了`staging/src/k8s.io/apiserver/pkg/registry/generic/registry/store.go`中的`Store`对象, 可以直接使用其中的通用方法.

## Cache

```
staging/src/k8s.io/apiserver/pkg/server/options/etcd.go
SimpleRestOptionsFactory.GetRESTOptions(), StorageFactoryRestOptionsFactory.GetRESTOptions()
|
├─  staging/src/k8s.io/apiserver/pkg/registry/generic/registry/storage_factory.go
    StorageWithCacher():
    |
    ├─  staging/src/k8s.io/apiserver/pkg/registry/generic/storage_decorator.go
    |   NewRawStorage()
    |
    ├─  staging/src/k8s.io/apiserver/pkg/storage/cacher/cacher.go
        NewCacherFromConfig()
        
```

几个钩子函数(钩子函数通过`PostStartHooks()`注册):

1. 