## kubelet 启动流程

```
cmd/kubelet/kubelet.go
main(): 程序入口
|
├─  cmd/kubelet/app/server.go
    NewKubeletCommand()
    |
    ├─  cmd/kubelet/app/options/options.go
        NewKubeletConfiguration(): 构造 KubeletServer 对象, 并通过 Run() 方法启动.
        |
        ├─  UnsecuredDependencies(): 构造 kubeletDeps 对象.
        |
        ├─  Run(): 不到10行, 什么也没做(就init了下win的service), 只是调用了下 run()
            |
            ├─  run()
                |   初始化 kubeDeps 对象的 KubeClient, EventClient, HeartbeatClient 成员
                |
                |
                ├─  pkg/kubelet/cadvisor/cadvisor_linux.go
                |   imageFsInfoProvider()
                ├─  pkg/kubelet/cadvisor/cadvisor_linux.go
                |   New(): 赋值给 kubeDeps.CAdvisorInterface 成员
                |
                |
                ├─  pkg/kubelet/cm/container_manager_linux.go
                |   NewContainerManager(): 赋值给 kubeDeps.ContainerManager 成员.
                |
                ├─  checkPermissions()
                |
                ├─  RunKubelet()
                    |
                    ├─  cmd/kubelet/app/server.go
                    |   createAndInitKubelet()
                    |   |
                    |   ├─  pkg/kubelet/kubelet.go
                    |   |   NewMainKubelet(): 初始化 `Kubelet` 结构体对象, 这个函数的传入参数巨多...
                    |   |   |   同时初始化很多子系统, 包括 oomwatcher, secretManager, configMapManager, 健康检测工具 等.
                    |   |   |
                    |   |   ├─  makePodSourceConfig(): 赋值给 kubeDeps.PodConfig 成员.
                    |   |   |
                    |   |   ├─  staging/src/k8s.io/client-go/tools/cache/store.go
                    |   |   |   NewIndexer()
                    |   |   |
                    |   |   |   以下创建 serviceIndexer, nodeIndexer 及对应的 Lister
                    |   |   ├─  staging/src/k8s.io/client-go/tools/cache/listwatch.go
                    |   |   |   NewListWatchFromClient()
                    |   |   ├─  staging/src/k8s.io/client-go/tools/cache/reflector.go
                    |   |   |   NewReflector()
                    |   |   |   Reflector.Run()
                    |   |   |
                    |   |   ├─  pkg/kubelet/container/container_reference_manager.go
                    |   |   |   NewRefManager(): RefManager 就是一个 **容器ID:ObjectReference 对象的 map**, 加上一个读写锁.
                    |   |   |       ObjectReference 包含了资源的 Kind, NS, Name等信息.
                    |   |   |
                    |   |   ├─  pkg/kubelet/oom/oom_watcher_linux.go
                    |   |   |   NewWatcher(): 这里只创建, 但还未启动(需要调用 oomwatcher 对象的 Start() 方法)
                    |   |   |
                    |   |   ├─  pkg/kubelet/prober/results/results_manager.go
                    |   |   |   NewManager(): 赋值给 Kubelet.livenessManager 成员
                    |   |   |
                    |   |   ├─  pkg/kubelet/container/cache.go
                    |   |   |   NewCache(): 赋值给 Kubelet.podCache 成员
                    |   |   |
                    |   |   ├─  pkg/kubelet/pod/pod_manager.go
                    |   |   |   NewBasicPodManager(): 赋值给 Kubelet.podManager 成员
                    |   |   |
                    |   |   ├─  pkg/kubelet/status/status_manager.go
                    |   |   |   NewManager(): 赋值给 Kubelet.statusManager 成员
                    |   |   |
                    |   |   ├─  pkg/kubelet/server/stats/resource_analyzer.go
                    |   |   |   NewResourceAnalyzer(): 赋值给 Kuberlet.resourceAnalyzer 成员
                    |   |   |
                    |   |   ├─  pkg/kubelet/dockershim/docker_service.go
                    |   |   |   NewDockerService(): 创建 dockerService 对象, 其中的 client 成员为与 docker.sock 通信的接口.
                    |   |   |   |
                    |   |   |   ├─  NewDockerClientFromConfig()
                    |   |   |   |
                    |   |   |   ├─  pkg/kubelet/dockershim/libdocker/instrumented_client.go
                    |   |   |   |   NewInstrumentedInterface()
                    |   |   |   |
                    |   |   |   ├─  pkg/kubelet/dockershim/docker_service.go
                    |   |   |   |   dockerService.checkVersionCompatibility(): 检测 docker 与 kubelet 的版本兼容性.
                    |   |   |   |
                    |   |   |   ├─  pkg/kubelet/dockershim/network/cni/cni.go
                    |   |   |   |   ProbeNetworkPlugins(): 读取 /etc/cni/net.d 和 /opt/cni/bin 目录, 设置默认使用的 cni 插件
                    |   |   |   ├─  pkg/kubelet/dockershim/network/kubenet/kubenet_linux.go
                    |   |   |   |   NewPlugin(): 设置 kuber 官方内置的 kubenet 插件, 不过排在后面, 一般不使用.
                    |   |   |   ├─  pkg/kubelet/dockershim/network/plugins.go
                    |   |   |   |   InitNetworkPlugin(): 找到配置文件中指定的插件, 对其进行初始化
                    |   |   |   |       其实就是加载一下 br-netfilter 内核模块, 调用 sysctl 允许 iptables 操作.
                    |   |   |   ├─  pkg/kubelet/dockershim/network/plugins.go
                    |   |   |   |   NewPluginManager(): 直接返回一个 PluginManager 结构体对象(贫穷函数)
                    |   |   |   |
                    |   |   |   ├─  ds.cgroupDriver = cgroupDriver
                    |   |   |   |   kubelet 中配置的 cgroup driver 与 dockerd 使用的不同, 会直接使用 dockerd 的 driver
                    |   |   |
                    |   |   |
                    |   |   ├─  pkg/kubelet/dockershim/remote/docker_server.go
                    |   |   |   NewDockerServer(): 直接返回 DockerServer 结构体对象(贫穷函数)
                    |   |   ├─  pkg/kubelet/dockershim/remote/docker_server.go
                    |   |   |   DockerServer.Start()
                    |   |   |   |
                    |   |   |   ├─  pkg/kubelet/dockershim/docker_service.go
                    |   |   |   |   DockerServer.service.Start(): 调用 dockerService 成员对象的 Start() 方法
                    |   |   |   |   |
                    |   |   |   |   ├─  dockerService.containerManager.Start()
                    |   |   |   |
                    |   |   |   ├─  grpc.NewServer(): 赋值给 DockerServer.server 成员, 作为 grpc server
                    |   |   |   ├─  runtimeapi.RegisterRuntimeServiceServer(DockerServer.server, DockerServer.service)
                    |   |   |   ├─  runtimeapi.RegisterImageServiceServer(DockerServer.server, DockerServer.service)
                    |   |   |   |       接收客户端(runtime 和 image 方面的)请求, 并转发给 dockerService 
                    |   |   |   |
                    |   |   |   ├─  
                    |   |   |
                    |   |   ├─  pkg/kubelet/dockershim/docker_legacy_service.go
                    |   |   |   dockerService.IsCRISupportedLogDriver()
                    |   |   |
                    |   |   ├─  getRuntimeAndImageServices()
                    |   |   |
                    |   |   ├─  pkg/kubelet/kuberuntime/kuberuntime_manager.go
                    |   |   |   NewKubeGenericRuntimeManager(): 返回值被赋予给了 Kubelet 的 
                    |   |   |   |   containerRuntime, streamingRuntime 和 runner 3个成员.
                    |   |   |
                    |   |   ├─  pkg/kubelet/container/runtime_cache.go
                    |   |   |   NewRuntimeCache(): 赋值给 Kubelet.runtimeCache 成员.
                    |   |   |
                    |   |   ├─  pkg/kubelet/pleg/generic.go
                    |   |   |   NewGenericPLEG(): 直接返回 GenericPLEG 结构体对象(贫穷函数)
                    |   |   |
                    |   |   ├─  newRuntimeState(): 赋值给 Kubelet.runtimeState 成员
                    |   |   |
                    |   |   ├─  pkg/kubelet/container/container_gc.go
                    |   |   |   NewContainerGC(): 赋值给 Kubelet.containerGC 成员
                    |   |   |
                    |   |   ├─  newPodContainerDeletor(): 赋值给 Kubelet.containerDeletor 成员
                    |   |   |
                    |   |   ├─  pkg/kubelet/images/image_gc_manager.go
                    |   |   |   NewImageGCManager(): 赋值给 Kubelet.imageManager 成员
                    |   |   |
                    |   |   ├─  pkg/kubelet/logs/container_log_manager.go
                    |   |   |   NewContainerLogManager(): 赋值给 Kubelet.containerLogManager 成员
                    |   |   |       用于日志轮替.
                    |   |   |
                    |   |   ├─  pkg/kubelet/certificate/kubelet.go
                    |   |   |   NewKubeletServerCertificateManager(): 赋值给 Kubelet.serverCertificateManager 成员.
                    |   |   |
                    |   |   ├─  pkg/kubelet/prober/prober_manager.go
                    |   |   |   NewManager(): 赋值给 Kubelet.probeManager 成员, 用于 live/ready 检测.
                    |   |   |
                    |   |   ├─  NewInitializedVolumePluginMgr(): 赋值给 Kubelet.volumePluginMgr 成员
                    |   |   |
                    |   |   ├─  pkg/kubelet/pluginmanager/plugin_manager.go
                    |   |   |   NewPluginManager(): 赋值给 Kubelet.pluginManager 成员
                    |   |   |
                    |   |   ├─  pkg/kubelet/volumemanager/volume_manager.go
                    |   |   |   NewVolumeManager(): 赋值给 Kubelet.volumeManager 成员
                    |   |   |
                    |   |   ├─  NewReasonCache(): 赋值给 Kubelet.reasonCache 成员
                    |   |   |
                    |   |   ├─  pkg/kubelet/util/queue/work_queue.go
                    |   |   |   NewBasicWorkQueue(): 赋值给 Kubelet.workQueue 成员
                    |   |   |
                    |   |   ├─  newPodWorkers(): 赋值给 Kubelet.podWorkers 成员
                    |   |   |       直接返回 podWorkers 结构体对象(贫穷函数)
                    |   |   |
                    |   |   ├─  staging/src/k8s.io/client-go/util/flowcontrol/backoff.go
                    |   |   |   NewBackOff(): 赋值给 Kubelet.backOff 成员
                    |   |   |
                    |   |   ├─  pkg/kubelet/eviction/eviction_manager.go
                    |   |   |   NewManager(): 赋值给 Kubelet.evictionManager 成员
                    |   |   |
                    |   |   ├─  pkg/kubelet/sysctl/runtime.go
                    |   |   |   NewRuntimeAdmitHandler(): features.Sysctls, 允许在容器中使用 sysctl .
                    |   |   |
                    |   |   ├─  pkg/kubelet/nodelease/controller.go
                    |   |   |   NewController(): 赋值给 Kubelet.nodeLeaseController 成员
                    |   |   |
                    |   |   ├─  defaultNodeStatusFuncs(): 赋值给 Kubelet.setNodeStatusFuncs 成员
                    |   |
                    |   ├─  pkg/kubelet/kubelet.go
                    |   |   Kubelet.BirthCry(): kubelet 启动成功, 发送出一条 event
                    |   |
                    |   ├─  pkg/kubelet/kubelet.go
                    |   |   Kubelet.StartGarbageCollection()
                    |   
                    |   
                    ├─  startKubelet()
                        |
                        ├─  pkg/kubelet/kubelet.go
                        |   Kubelet.Run(updates <-chan kubetypes.PodUpdate): 
                        |   |   虽然传入了 updates, 但这里没用, 而是直接传入 Kubelet.syncLoop(updates) 方法了. 
                        |   |   启动各种子级协程, 监控volume的, 监控node状态的, 初始化iptables表什么的...
                        |   |   最后进入阻塞循环, 监听 apiserver 的 Pod 变动事件(syncLoop 方法).
                        |   |
                        |   ├─  Kubelet.initializeModules(): 初始化一些无需docker运行就可以启动的模块, 
                        |   |   |   如设置kubelet数据目录, 容器日志目录, 启动镜像管理器, oom监听器, 和资源监控器等.
                        |   |   |
                        |   |   ├─  Kubelet.setupDataDirs(): 设置 kubelet 数据目录 /var/lib/kubelet, 及其中的子目录.
                        |   |   |
                        |   |   ├─  Kubelet.imageManager.Start(): 其实是 ImageGCManager, 主要用于废弃的 image 镜像清理.
                        |   |   |
                        |   |   |
                        |   |   ├─  Kubelet.oomWatcher.Start(): 开始监听系统中的 OOM 事件(通过解析 /dev/kmsg 内容实现此功能)
                        |   |   |
                        |   |   ├─  Kubelet.resourceAnalyzer.Start(): 说是监测 node 上的资源消耗, 但感觉
                        |   |   |   貌似只监控并存储了 Pod 的 volume 数据, 没做什么限制操作.
                        |   |
                        |   |
                        |   |
                        |   |
                        |   ├─  Kubelet.kl.volumeManager.Run()
                        |   |
                        |   ├─  pkg/kubelet/kubelet_node_status.go
                        |   |   Kubelet.syncNodeStatus()
                        |   |   |
                        |   |   ├─  Kubelet.registerWithAPIServer(): 向 apiserver 注册当前 node, 如果已经注册过会立即返回.
                        |   |   |
                        |   |   ├─  Kubelet.updateNodeStatus(): 多次尝试向 apiserver 更新 node 状态
                        |   |       |   
                        |   |       |
                        |   |       ├─  Kubelet.tryUpdateNodeStatus(): 要么到时间定时更新, 要么真的发生变动主动更新
                        |   |       |   |   features.NodeLease
                        |   |       |   |
                        |   |       |   |
                        |   |       |   |
                        |   |       |   ├─
                        |   |       |
                        |   |
                        |   ├─  Kubelet.nodeLeaseController.Run(): 如果开启 NodeLease 特性, 则执行此函数.
                        |   |   |   nodeLeaseController 成员在 NewMainKubelet() 函数中被初始化.
                        |   |
                        |   ├─  Kubelet.updateRuntimeUp()
                        |   |
                        |   ├─  pkg/kubelet/kubelet_network_linux.go
                        |   |   Kubelet.syncNetworkUtil(): 开始维护宿主机上的 iptables 规则, 这是一个周期任务, 且永不停止.
                        |   |
                        |   ├─  pkg/kubelet/kubelet_pods.go
                        |   |   podKiller(): 处理 Kubelet.podKillingCh 队列中删除的 Pod.
                        |   |
                        |   ├─  Kubelet.statusManager.Start()
                        |   ├─  Kubelet.probeManager.Start()
                        |   ├─  Kubelet.runtimeClassManager.Start()
                        |   ├─  Kubelet.pleg.Start()
                        |   |
                        |   ├─  Kubelet.syncLoop(PodUpdate)
                        |   |   |
                        |   |   ├─  Kubelet.syncLoopIteration(): 就是一个 select, 读取多个 channel 的信息并处理.
                        |   |       |   监听的 channel 有 PodUpdate, pleg.PodLifecycleEvent, proberesults.Update,
                        |   |       |   还有几个定时器(是不是到时间了, 要不要处理定时任务什么的)
                        |   |       |
                        |   |       ├─  PodUpdate channel
                        |   |           |
                        |   |           ├─  Kubelet.HandlePodUpdates()
                        |   |           ├─  Kubelet.HandlePodRemoves()
                        |   |           ├─  Kubelet.HandlePodReconcile()
                        |   |           ├─  Kubelet.HandlePodAdditions()
                        |   |               |
                        |   |               ├─  Kubelet.podManager.GetMirrorPodByPod(): 尝试获取新增 Pod 的 mirror pod 记录
                        |   |               |
                        |   |               ├─  Kubelet.dispatchWork():
                        |   |               |   |
                        |   |               |   ├─  Kubelet.podWorkers.UpdatePod(): !!! 主要
                        |   |               |   |       kubelet 主要是通过 podWorkers 完成 Pod 的部署工作的.
                        |   |               |
                        |   |               ├─  Kubelet.probeManager.AddPod(): 添加新增 Pod 的健康检测线程.
                        |
                        |
                        ├─  pkg/kubelet/kubelet.go
                            Kubelet.ListenAndServe(): 启动监听着 10250 端口的 http server.
```

## Pod/Container 创建流程

```
pkg/kubelet/kubelet.go
Kubelet.HandlePodAdditions(), Kubelet.HandlePodUpdates(), Kubelet.HandlePodReconcile()
|   HandlePodAdditions() 通过调用 Kubelet.dispatchWork() 调用 Kubelet.podWorkers.UpdatePod(), 
|   所以 UpdatePod() 是最终用于部署 Pod 工作的方法.
|
├─  pkg/kubelet/pod_workers.go
    podWorkers.UpdatePod()
    |
    ├─  podWorkers.managePodLoop():
        |
        ├─  podWorkers.syncPodFn() (实际是 Kubelet.syncPod() 方法)
            |
            ├─  pkg/kubelet/kubelet.go
            |   Kubelet.containerManager.NewPodContainerManager()
            ├─  pkg/kubelet/cm/pod_container_manager_linux.go
            |   podContainerManagerImpl.EnsureExists()
            |   |   为目标 Pod 创建 cgroup 层级.
            |   |
            |   ├─  podContainerManagerImpl.cgroupManager.Create()
            |
            ├─  Kubelet.containerRuntime.SyncPod()
                pkg/kubelet/kuberuntime/kuberuntime_manager.go
                kubeGenericRuntimeManager.SyncPod()
                |
                ├─  kubeGenericRuntimeManager.computePodActions()
                |   1. 计算 sandbox 和 container 的差异变化.
                |
                ├─  kubeGenericRuntimeManager.killPodWithSyncResult()
                |   2. 如果 sandbox 发生变化, 对应的 container 需要删除重建.
                |
                ├─  
                |
                ├─  kubeGenericRuntimeManager.createPodSandbox()
                |   4. 如果有必要, 为 Pod 创建 sandbox 容器.
                |
                ├─  kubeGenericRuntimeManager.startContainer
                |   |   启动启动常规的 container, 用于初始化的 initContainers,
                |   |   和临时调试的 ephemeralContainers
                |   |
                |   ├─  pkg/kubelet/kuberuntime/kuberuntime_container.go
                |   |   kubeGenericRuntimeManager.startContainer()
                |   |   |
                |   |   ├─  kubeGenericRuntimeManager.imagePuller.EnsureImageExists()
                |   |   |   1. 拉取镜像
                |   |   ├─  pkg/kubelet/container/ref.go
                |   |   |   GenerateContainerRef()
                |   |   |
                |   |   ├─  pkg/kubelet/kuberuntime/kuberuntime_container.go
                |   |   |   kubeGenericRuntimeManager.runtimeService.CreateContainer()
                |   |   |   2. 创建容器 一直忘记 docker 还有一个 create 子命令, 可以只创建而不启动.
                |   |   |
                |   |   ├─  pkg/kubelet/kuberuntime/kuberuntime_container.go
                |   |   |   kubeGenericRuntimeManager.runtimeService.StartContainer()
                |   |   |   |   3. 启动容器
                |   |   |   |
                |   |   |   ├─  pkg/kubelet/remote/remote_runtime.go
                |   |   |       RemoteRuntimeService.StartContainer()
                |   |   |       |
                |   |   |       ├─  RemoteRuntimeService.runtimeClient.StartContainer()
                |   |   |           这里的 runtimeClient 是连接 /var/run/dockershim.sock 的
                |   |   |           grpc 客户端对象.
                |   |   |
                |   |   ├─  pkg/kubelet/kuberuntime/kuberuntime_container.go
                |   |   |   kubeGenericRuntimeManager.runner.Run()
                |   |   |   4. 执行 PostStart 钩子函数
                |   |
                |   |
                |
                ├─
                ├─
```
