```
cmd/kubelet/kubelet.go
main(): 程序入口
|
├─  cmd/kubelet/app/server.go
    NewKubeletCommand()
    |
    ├─  cmd/kubelet/app/options/options.go
        NewKubeletConfiguration(): 构造 KubeletServer 对象, 并通过 Run() 方法启动.
        |
        ├─  UnsecuredDependencies(): 构造 kubeletDeps 对象.
        |
        ├─  Run(): 不到10行, 什么也没做(就init了下win的service), 只是调用了下 run()
            |
            ├─  run()
                |   初始化 kubeDeps 对象的 KubeClient, EventClient, HeartbeatClient 成员
                |
                |
                ├─  pkg/kubelet/cadvisor/cadvisor_linux.go
                |   imageFsInfoProvider()
                ├─  pkg/kubelet/cadvisor/cadvisor_linux.go
                |   New(): 赋值给 kubeDeps.CAdvisorInterface 成员
                |
                |
                ├─  pkg/kubelet/cm/container_manager_linux.go
                |   NewContainerManager(): 赋值给 kubeDeps.ContainerManager 成员.
                |
                ├─  checkPermissions()
                |
                ├─  RunKubelet()
                    |
                    ├─  cmd/kubelet/app/server.go
                    |   createAndInitKubelet()
                    |   |
                    |   ├─  pkg/kubelet/kubelet.go
                    |   |   NewMainKubelet(): 初始化 `Kubelet` 结构体对象, 这个函数的传入参数巨多...
                    |   |   |   同时初始化很多子系统, 包括 oomwatcher, secretManager, configMapManager, 健康检测工具 等.
                    |   |   |
                    |   |   ├─  makePodSourceConfig(): 赋值给 kubeDeps.PodConfig 成员.
                    |   |   |
                    |   |   ├─  staging/src/k8s.io/client-go/tools/cache/store.go
                    |   |   |   NewIndexer()
                    |   |   |
                    |   |   |   以下创建 serviceIndexer, nodeIndexer 及对应的 Lister
                    |   |   ├─  staging/src/k8s.io/client-go/tools/cache/listwatch.go
                    |   |   |   NewListWatchFromClient()
                    |   |   ├─  staging/src/k8s.io/client-go/tools/cache/reflector.go
                    |   |   |   NewReflector()
                    |   |   |   Reflector.Run()
                    |   |   |
                    |   |   ├─  pkg/kubelet/container/container_reference_manager.go
                    |   |   |   NewRefManager(): RefManager 就是一个 **容器ID:ObjectReference 对象的 map**, 加上一个读写锁.
                    |   |   |       ObjectReference 包含了资源的 Kind, NS, Name等信息.
                    |   |   |
                    |   |   ├─  pkg/kubelet/oom/oom_watcher_linux.go
                    |   |   |   NewWatcher(): 这里只创建, 但还未启动(需要调用 oomwatcher 对象的 Start() 方法)
                    |   |   |
                    |   |   ├─  pkg/kubelet/prober/results/results_manager.go
                    |   |   |   NewManager(): 赋值给 Kubelet.livenessManager 成员
                    |   |   |
                    |   |   ├─  pkg/kubelet/container/cache.go
                    |   |   |   NewCache(): 赋值给 Kubelet.podCache 成员
                    |   |   |
                    |   |   ├─  pkg/kubelet/pod/pod_manager.go
                    |   |   |   NewBasicPodManager(): 赋值给 Kubelet.podManager 成员
                    |   |   |
                    |   |   ├─  pkg/kubelet/status/status_manager.go
                    |   |   |   NewManager(): 赋值给 Kubelet.statusManager 成员
                    |   |   |
                    |   |   ├─  pkg/kubelet/server/stats/resource_analyzer.go
                    |   |   |   NewResourceAnalyzer(): 赋值给 Kuberlet.resourceAnalyzer 成员
                    |   |   |
                    |   |   ├─  pkg/kubelet/dockershim/docker_service.go
                    |   |   |   NewDockerService(): 创建 dockerService 对象, 其中的 client 成员为与 docker.sock 通信的接口.
                    |   |   |   |
                    |   |   |   ├─  NewDockerClientFromConfig()
                    |   |   |   |
                    |   |   |   ├─  pkg/kubelet/dockershim/libdocker/instrumented_client.go
                    |   |   |   |   NewInstrumentedInterface()
                    |   |   |   |
                    |   |   |   ├─  pkg/kubelet/dockershim/docker_service.go
                    |   |   |   |   dockerService.checkVersionCompatibility(): 检测 docker 与 kubelet 的版本兼容性.
                    |   |   |   |
                    |   |   |   ├─  pkg/kubelet/dockershim/network/cni/cni.go
                    |   |   |   |   ProbeNetworkPlugins(): 读取 /etc/cni/net.d 和 /opt/cni/bin 目录, 设置默认使用的 cni 插件
                    |   |   |   ├─  pkg/kubelet/dockershim/network/kubenet/kubenet_linux.go
                    |   |   |   |   NewPlugin(): 设置 kuber 官方内置的 kubenet 插件, 不过排在后面, 一般不使用.
                    |   |   |   ├─  pkg/kubelet/dockershim/network/plugins.go
                    |   |   |   |   InitNetworkPlugin(): 找到配置文件中指定的插件, 对其进行初始化
                    |   |   |   |       其实就是加载一下 br-netfilter 内核模块, 调用 sysctl 允许 iptables 操作.
                    |   |   |   ├─  pkg/kubelet/dockershim/network/plugins.go
                    |   |   |   |   NewPluginManager(): 直接返回一个 PluginManager 结构体对象(贫穷函数)
                    |   |   |   |
                    |   |   |   ├─  ds.cgroupDriver = cgroupDriver
                    |   |   |   |   kubelet 中配置的 cgroup driver 与 dockerd 使用的不同, 会直接使用 dockerd 的 driver
                    |   |   |
                    |   |
                    |   ├─  pkg/kubelet/kubelet.go
                    |   |   Kubelet.BirthCry(): kubelet 启动成功, 发送出一条 event
                    |   |
                    |   ├─  pkg/kubelet/kubelet.go
                    |   |   Kubelet.StartGarbageCollection()
                    |   
                    |   
                    ├─  startKubelet()
                        |
                        ├─  pkg/kubelet/kubelet.go
                        |   Kubelet.Run(updates <-chan kubetypes.PodUpdate): 
                        |   |   虽然传入了 updates, 但这里没用, 而是直接传入 Kubelet.syncLoop(updates) 方法了. 
                        |   |   启动各种子级协程, 监控volume的, 监控node状态的, 初始化iptables表什么的...
                        |   |   最后进入阻塞循环, 监听 apiserver 的 Pod 变动事件(syncLoop 方法).
                        |   |
                        |   ├─  Kubelet.initializeModules(): 初始化一些无需docker运行就可以启动的模块, 
                        |   |   |   如设置kubelet数据目录, 容器日志目录, 启动镜像管理器, oom监听器, 和资源监控器等.
                        |   |   |
                        |   |   ├─  Kubelet.setupDataDirs(): 设置 kubelet 数据目录 /var/lib/kubelet, 及其中的子目录.
                        |   |   |
                        |   |   ├─  Kubelet.imageManager.Start(): 其实是 ImageGCManager, 主要用于废弃的 image 镜像清理.
                        |   |   |
                        |   |   |
                        |   |   ├─  Kubelet.oomWatcher.Start(): 开始监听系统中的 OOM 事件(通过解析 /dev/kmsg 内容实现此功能)
                        |   |   |
                        |   |   ├─  Kubelet.resourceAnalyzer.Start(): 说是监测 node 上的资源消耗, 但感觉
                        |   |   |   貌似只监控并存储了 Pod 的 volume 数据, 没做什么限制操作.
                        |   |
                        |   |
                        |   |
                        |   |
                        |   ├─  Kubelet.kl.volumeManager.Run()
                        |   |
                        |   ├─  pkg/kubelet/kubelet_node_status.go
                        |   |   Kubelet.syncNodeStatus()
                        |   |   |
                        |   |   ├─  Kubelet.registerWithAPIServer(): 向 apiserver 注册当前 node, 如果已经注册过会立即返回.
                        |   |   |
                        |   |   ├─  Kubelet.updateNodeStatus(): 
                        |   |
                        |   |
                        |   ├─
                        |   ├─
                        |   ├─
                        |   |
                        |   ├─  Kubelet.syncLoop(PodUpdate)
                        |
                        |
                        ├─  pkg/kubelet/kubelet.go
                            Kubelet.ListenAndServe(): 启动监听着 10250 端口的 http server.
```

